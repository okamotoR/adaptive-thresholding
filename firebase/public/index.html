<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Extractor</title>
</head>
<base href="/">
<body style="background-color: rgb(219, 219, 241)">
    <div style="text-align: center;">
        <div style="margin: 1rem;">
            <div>線画抽出アプリ LineExtractor(β)</div>
            <div style="font-size: 0.7em;color: gray;">スマホ等で撮った線画を抽出するアプリです</div>
        </div>
        <div style="display: inline-block;">
            <input type="file" accept="image/*" onchange="initImageData(event)">
            <div id="canvas_container" style="width:90vw;height:90vmin;"><canvas id="canvas"></canvas></div>
        </div>
        <div>
            <div>
                <span>roughness</span>
                <input type="range" id="roughnessRange" max="255" min="0" step="1" onchange="changeRoughness(event)">
                <input type="number" id="roughnessNumber" max="255" min="0" onchange="changeRoughness(event)">
            </div>
            <div>
                <span>brightness</span>
                <input type="range" id="brightnessRange" max="255" min="0" step="1" oninput="changeBrightness(event)">
                <input type="number" id="brightnessNumber" max="255" min="0" onchange="changeBrightness(event)">
            </div>
            <div>
                <button>
                    <a download="lineDrawing" id="saveButton">保存</a>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
<script type="module">
import init, { raw_img_to_gray_vec, generate_integral_image_vec, generate_integral_squared_image_vec, generate_base_paper_image_vec, generate_line_vec, threshold_line_vec, gray_vec_to_rgba_vec } from "./js/pkg/adaptive_thresholding.js";
import SliderInputManager from "./js/slider_input_manager.js";
import CanvasManager from "./js/canvas_manager.js";

let wasmIsInitialized = false
let width = null;
let height = null;
let seedGrayImageU8Array = null;
let integralImageU32Array = null;
let integralSquaredImageU32Array = null;
let lineImageU8Array = null;

const roughnessSliderManager = new SliderInputManager(
    document.getElementById('roughnessNumber'),
    document.getElementById('roughnessRange'),
    10
);
const brightnessSliderManager = new SliderInputManager(
    document.getElementById('brightnessNumber'),
    document.getElementById('brightnessRange'),
    10
);
const canvasEl = document.getElementById('canvas');
const containerEl = document.getElementById('canvas_container');
const canvasManager = new CanvasManager(canvasEl,containerEl);

async function initImageData(event) {
    if (!wasmIsInitialized) {
        await init();
    }
    const file = event.target.files[0];

    // FileReaderはawait不可
    const reader = new FileReader();
    reader.onload = async function() {
        try {
            const ext = file.name.split('.').pop();

            const img = await new Promise((resolve) => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => resolve(img);
            })
            width = img.width;
            height = img.height;
            const buffer = await file.arrayBuffer();
            const raw_data = new Uint8Array(buffer);

            seedGrayImageU8Array = raw_img_to_gray_vec(raw_data, ext);
            integralImageU32Array = generate_integral_image_vec(seedGrayImageU8Array, width, height);
            integralSquaredImageU32Array = generate_integral_squared_image_vec(seedGrayImageU8Array, width, height);

            applyRoughness()
            wasmIsInitialized = true;
        } catch (error) {
            window.alert("申し訳ありません。\nプログラムでエラーが発生しました。");
        }
    }
    reader.readAsDataURL(file)
}

function applyRoughness() {
    const basePaperImageU8Array = generate_base_paper_image_vec(integralImageU32Array, integralSquaredImageU32Array, width, height, roughnessSliderManager.value);
    lineImageU8Array = generate_line_vec(seedGrayImageU8Array, basePaperImageU8Array);

    // var histogram = Array(256).fill(0);
    // lineImageU8Array.forEach(v => {
    //     s[v]+=1;
    // });
    applyBrightness()
}

function applyBrightness() {
    const thresholdImageU8Array = threshold_line_vec(lineImageU8Array, 255 - brightnessSliderManager.value);
    const imageData = createImageData(thresholdImageU8Array, width, height);
    loadImageOnCanvas(imageData);
}

function createImageData(grayImageU8Array, width, height) {
    return new ImageData(new Uint8ClampedArray(gray_vec_to_rgba_vec(grayImageU8Array)), width, height);
}

function loadImageOnCanvas(imageData) {
    window.console.log('load');
    canvasManager.loadImage(imageData, width, height);
    const dataURL = document.getElementById('canvas').toDataURL('image/png');
    document.getElementById('saveButton').href = dataURL;
}

function changeRoughness(event) {
    const value = event.target.value
    if (isNaN(value)) {
        return;
    }
    roughnessSliderManager.changeValue(Math.ceil(value))
    if (!wasmIsInitialized) {
        return;
    }
    applyRoughness()
}

function changeBrightness(event) {
    const value = event.target.value
    if (isNaN(value)) {
        return;
    }
    brightnessSliderManager.changeValue(Math.ceil(value))
    if (!wasmIsInitialized) {
        return;
    }
    applyBrightness()
}

function logtime(int) {
    console.log(int);
    console.log(window.performance.now());
}
window.logtime = logtime

window.initImageData = initImageData
window.changeRoughness = changeRoughness
window.changeBrightness = changeBrightness
</script>